<!DOCTYPE html>
<html>
  <head>
    <title>登入｜YZB 控制台</title>
    <link rel="stylesheet" href="./../css/login-style.css" />
  </head>
  <body>
    <div class="main">
      <div class="use-cookie-alert">
        <span class="closebtn" onclick="alert_close()">&times;</span>
        登入後代表你同意使用 Cookie 以及其相關使用政策。
      </div>
      <script>
        var close = document.getElementsByClassName("closebtn");
        var i;

        for (i = 0; i < close.length; i++) {
          close[i].onclick = function(){
            var div = this.parentElement;
            div.style.opacity = "0";
            setTimeout(function(){ div.style.display = "none"; }, 600);
          }
        }
</script>
      <div class="form-box">
        <img src="./../assets/YZB.png" class="avatar" />
        <div class="button-box">
          <div id="btn"></div>
          <button type="button" class="toggle-btn" onclick="login()">
            登入
          </button>
          <button type="button" class="toggle-btn" onclick="register()">
            註冊
          </button>
        </div>
        <div id="login" class="input-group" action="">
          <div class="login-error-msg">
              <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
              無效的 用戶名 或 密碼
          </div>
          <script>
            const loginErrorMsg = document.getElementById("login-error-msg");
            document.querySelector('.login-error-msg').style.display = 'none';
            //先取得網址字串
            var url = location.href;
            //再來用去尋找網址列中是否有資料傳遞(QueryString)
            if(url.indexOf('?')!=-1){
                var err = "";
                //在此直接將各自的參數資料切割放進ary中
                var ary = url.split('?')[1].split('&');
                //此時ary的內容為：
               //ary[0] = 'err=true'
    
                //下迴圈去搜尋每個資料參數
                for(i=0;i<=ary.length-1;i++)
                {
                    //如果資料名稱為id的話那就把他取出來
                   if(ary[i].split('=')[0] == 'err')
                        err = ary[i].split('=')[1];
                }
    
                if (err == 'true') {
                  document.querySelector('.login-error-msg').style.display = 'block';
                }
            }
          
          </script>
          <!-- Discord 登入，請輸入到以下網址 -->
          <a
            class="discord-btn"
            href="./login/discord"
            ><img
              src="./../assets/discord.png"
              width="20"
              heigh="20"
              alt="Discord icon"
              align="center"
            />
            用 Discord 登入
          </a>
          <script>
            function generateRandomString() {
              let randomString = "";
              const randomNumber = Math.floor(Math.random() * 10);

              for (let i = 0; i < 20 + randomNumber; i++) {
                randomString += String.fromCharCode(
                  33 + Math.floor(Math.random() * 94)
                );
              }

              return randomString;
            }

            // 讀取資料
            window.onload = () => {
              const fragment = new URLSearchParams(
                window.location.hash.slice(1)
              );
              const [accessToken, tokenType, state] = [
                fragment.get("access_token"),
                fragment.get("token_type"),
                fragment.get("state"),
              ];

              if (!accessToken) {
                const randomString = generateRandomString();
                localStorage.setItem("oauth-state", randomString);

                document.getElementById(
                  "login"
                ).href += `&state=${encodeURIComponent(btoa(randomString))}`;
                return (document.getElementById("login").style.display =
                  "block");
              }

              if (
                localStorage.getItem("oauth-state") !==
                atob(decodeURIComponent(state))
              ) {
                return console.log("您可能被點擊劫持了！");
              }

              fetch("https://discord.com/api/users/@me", {
                headers: {
                  authorization: `${tokenType} ${accessToken}`,
                },
              })
                .then((result) => result.json())
                .then((response) => {
                  const { username, discriminator } = response;
                  document.getElementById(
                    "info"
                  ).innerText += ` ${username}#${discriminator}`;
                })
                .catch(console.error);
            };
          </script>
          <!-- 或者 -->
          <p class="login_or">
            <hr>
          </p>
          <!-- 非DC登入 -->
          <input
            id="login_username"
            type="text"
            class="input-field"
            placeholder="名稱"
            required
          />
          <input
            id="login_password"
            type="password"
            class="input-field"
            placeholder="輸入密碼"
            required
          />
          <input type="checkbox" class="check-box" /><span class="check-box-text">記住我?</span>
          <button id="login_submit" type="submit" class="submit-btn">
            登入
          </button>
        </div>
        <div id="register" class="input-group" action="">
          <input
            id="register_username"
            type="email"
            class="input-field"
            placeholder="Email 帳號"
            required
            disabled
          />
          <input
            id="register_password"
            type="password"
            class="input-field"
            placeholder="密碼"
            required
            disabled
          />
          <input type="checkbox" class="check-box" /><span
            >我同意此服務政策與隱私條款</span
          >
          <button id="register_submit" type="submit" class="submit-btn" disabled>
            註冊 (現在不開放)
          </button>
        </div>
      </div>
    </div>
    <script>
      // 這是登入&註冊的動畫
      var x = document.getElementById("login");
      var y = document.getElementById("register");
      var z = document.getElementById("btn");
      function register() {
        x.style.left = "-400px";
        y.style.left = "50px";
        z.style.left = "110px";
      }
      function login() {
        x.style.left = "50px";
        y.style.left = "450px";
        z.style.left = "0";
      }

      // 取得資料
      async function postData(url = "", data = {}) {
        console.log(url,data)
        // 預設的選項被標記為 *
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });
        let res_data = await response.json()
        return res_data;
      }
      // #region 登入
      // 登入的動作
      let login_form = document.getElementById("login_submit");
      // 進行按鈕監聽
      login_form.addEventListener("click",async () => {
        let username = document.getElementById("login_username").value;
        let password = document.getElementById("login_password").value;
        console.log("登入帳號密碼：", username, password);
        let resp = await postData('/login',{user: username, password: password,isregister: false})
        if (resp.success == true) {
        } else {
          alert('錯誤：' + resp.errormsg)
        }
      });
      // #endregion 登入
      // #region 註冊
      let register_form = document.getElementById("register_submit");
      // 進行按鈕監聽
      register_form.addEventListener("click", async () => {
        let username = document.getElementById("register_username").value;
        let password = document.getElementById("register_password").value;
        console.log("註冊帳號密碼：", username, password);
        let resp = await postData('/login',{user: username, password: password,isregister: true})
        if (resp.success == true) {
          await alert('成功註冊！現在可以登入了！')
          window.location.href = "./login";
        } else {
          alert('錯誤：' + resp.errormsg)
        }
      });
      // #endregion 註冊
    </script>
  </body>
  <body>
    <noscript>你需要使用Js才可啟用此html</noscript>
    <div id="root"></div>
  </body>
</html>
